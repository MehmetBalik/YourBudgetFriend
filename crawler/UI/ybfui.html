<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Your Budget Friend</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    /* Global layout */
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        margin: 0;
        padding: 0;
    }

    header {
        background: #0077cc;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 28px;
        font-weight: bold;
    }

    /* Filter container */
    .filter-box {
        background: white;
        padding: 20px;
        margin: 20px auto;
        max-width: 700px;
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(0,0,0,0.15);
    }

    .filter-row {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    label {
        font-weight: bold;
    }

    select {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    /* Dual price slider UI */
    .range-slider {
        width: 100%;
        position: relative;
        height: 40px;
        margin-top: 10px;
    }

    .slider-track {
        width: 100%;
        height: 8px;
        background: #d3d3d3;
        border-radius: 5px;
        position: absolute;
        top: 16px;
    }

    .slider-range {
        height: 8px;
        background: #0077cc;
        position: absolute;
        top: 16px;
        border-radius: 5px;
    }

    .range-slider input[type=range] {
        position: absolute;
        width: 100%;
        height: 0;
        -webkit-appearance: none;
        background: none;
        pointer-events: none;
    }

    .range-slider input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: #0077cc;
        cursor: pointer;
        pointer-events: all;
        z-index: 3;
    }

    .price-values {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
    }

    /* Search results layout */
    .results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        padding: 20px;
        max-width: 1100px;
        margin: auto;
    }

    .item {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 6px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .item-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .item-info {
        color: #555;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .item a {
        color: #0077cc;
        text-decoration: none;
        font-weight: bold;
        margin-top: auto;
    }
</style>
</head>

<body>

<header>Your Budget Friend</header>

<div class="filter-box">
    <div class="filter-row">

        <!-- CATEGORY DROPDOWN (DYNAMICALLY LOADED) -->
        <label for="type">Clothing Type</label>
        <select id="type">
            <option value="">Any</option>
        </select>

        <!-- SORTING OPTIONS -->
        <label>Sort By</label>
        <select id="sort">
            <option value="">None</option>
            <option value="priceAsc">Price: Low → High</option>
            <option value="priceDesc">Price: High → Low</option>
            <option value="nameAsc">A → Z</option>
            <option value="nameDesc">Z → A</option>
        </select>

        <!-- PRICE SLIDER -->
        <label>Price Range</label>
        <div class="range-slider">
            <div class="slider-track"></div>
            <div class="slider-range" id="sliderRange"></div>

            <input type="range" id="minSlider" min="0" max="200" value="0" step="1" oninput="updateSlider()">
            <input type="range" id="maxSlider" min="0" max="200" value="200" step="1" oninput="updateSlider()">
        </div>

        <div class="price-values">
            <span id="minVal">$0</span>
            <span id="maxVal">$200</span>
        </div>

        <!-- SEARCH BUTTON -->
        <button onclick="applyFilters()" style="padding:12px; background:#0077cc; border:none; color:white; border-radius:5px;">
            Search
        </button>

        <!-- CRAWLER TRIGGER BUTTON -->
        <button onclick="triggerCrawl()" style="padding:12px; background:#28a745; border:none; color:white; border-radius:5px;">
            Crawl New Data
        </button>

        <p id="crawl-status" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
        <p id="last-updated" style="text-align:center; margin-top:5px; font-style:italic; color:#555;"></p>
    </div>
</div>

<!-- RESULTS -->
<div class="results" id="results"></div>

<script>
let items = [];
let categories = new Set();

/* -----------------------------
   TRIGGER BACKEND CRAWLER
------------------------------*/
async function triggerCrawl() {
    const status = document.getElementById("crawl-status");
    status.innerText = "⏳ Running crawler…";

    try {
        const res = await fetch("/run-crawler");
        const result = await res.json();

        if (result.status === "error") {
            status.innerText = `Crawler error: ${result.message}`;
            console.error("Crawler detailed error:", result.stdout, result.stderr);
            return;
        }

        status.innerText = "Data updated successfully!";
        await loadData(); // Directly load data once backend confirms completion

    } catch (err) {
        status.innerText = "Could not reach backend or an unknown error occurred.";
        console.error("Fetch error:", err);
    }
}

/* -----------------------------
   LOAD DATA JSON
------------------------------*/
async function loadData() {
    try {
        const response = await fetch("clothing_data.json");
        const data = await response.json(); // Now expects an object with lastUpdated and products

        items = data.products; // Extract products array
        
        categories.clear();
        items.forEach(item => categories.add(item.category));

        populateCategoryDropdown();

        // Display last updated timestamp
        const lastUpdatedElement = document.getElementById("last-updated");
        if (data.lastUpdated) {
            lastUpdatedElement.innerText = `Last crawled: ${data.lastUpdated}`;
        } else {
            lastUpdatedElement.innerText = "";
        }
        return data; // Return the full data object
    } catch (error) {
        console.log("clothing_data.json not found yet.", error);
        document.getElementById("last-updated").innerText = "No data available.";
        return null;
    }
}

/* -----------------------------
   POPULATE CATEGORY DROPDOWN
------------------------------*/
function populateCategoryDropdown() {
    const select = document.getElementById("type");
    select.innerHTML = `<option value="">Any</option>`;

    categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.toLowerCase();
        opt.textContent = cat;
        select.appendChild(opt);
    });
}

/* -----------------------------
   PRICE SLIDER UPDATE
------------------------------*/
function updateSlider() {
    let min = document.getElementById("minSlider").value;
    let max = document.getElementById("maxSlider").value;

    if (parseInt(min) > parseInt(max)) {
        [min, max] = [max, min];
        document.getElementById("minSlider").value = min;
        document.getElementById("maxSlider").value = max;
    }

    document.getElementById("minVal").innerText = "$" + min;
    document.getElementById("maxVal").innerText = "$" + max;

    const percentMin = (min / 200) * 100;
    const percentMax = (max / 200) * 100;

    const range = document.getElementById("sliderRange");
    range.style.left = percentMin + "%";
    range.style.right = (100 - percentMax) + "%";
}

/* -----------------------------
   SORTING FUNCTION
------------------------------*/
function extractPrice(item) {
    return parseFloat((item.price || "0").replace(/[^0-9.]/g, "")) || 0;
}

function sortItems(list, sortType) {
    if (sortType === "priceAsc") return list.sort((a, b) => extractPrice(a) - extractPrice(b));
    if (sortType === "priceDesc") return list.sort((a, b) => extractPrice(b) - extractPrice(a));
    if (sortType === "nameAsc") return list.sort((a, b) => a.name.localeCompare(b.name));
    if (sortType === "nameDesc") return list.sort((a, b) => b.name.localeCompare(a.name));
    return list;
}

/* -----------------------------
   FILTER + DISPLAY RESULTS
------------------------------*/
function applyFilters() {
    const type = document.getElementById("type").value.toLowerCase();
    const sortType = document.getElementById("sort").value;

    const minPrice = parseFloat(document.getElementById("minSlider").value);
    const maxPrice = parseFloat(document.getElementById("maxSlider").value);

    const resultsBox = document.getElementById("results");
    resultsBox.innerHTML = "";

    let filtered = items.filter(item => {
        const price = extractPrice(item);
        const category = (item.category || "").toLowerCase();

        return (
            (type === "" || category.includes(type)) &&
            price >= minPrice &&
            price <= maxPrice
        );
    });

    filtered = sortItems(filtered, sortType);

    if (filtered.length === 0) {
        resultsBox.innerHTML = "<p style='text-align:center;'>No results found.</p>";
        return;
    }

    filtered.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";

        div.innerHTML = `
            <div class="item-title">${item.name}</div>
            <div class="item-info">Price: ${item.price}</div>
            <div class="item-info">Availability: ${item.availability}</div>
            <div class="item-info">Category: ${item.category}</div>
            <a href="${item.link}" target="_blank">View Item</a>
        `;

        resultsBox.appendChild(div);
    });
}

loadData();
updateSlider();
</script>

</body>
</html>
